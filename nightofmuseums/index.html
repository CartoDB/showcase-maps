<!DOCTYPE html>
<html>
<head>
<title>OSM Buildings + CartoDB : Long night of museums Berlin 2014</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<!--link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css"-->
<style type="text/css">
html, body {
  border: 0;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
}
#map {
  height: 100%;
  background-color: #384047;
}
#mamufas {
  position: absolute;
  top: 0px;
  left: 0px;
  right: 0px;
  width: 100%;
  color: #fff;
  pointer-events:none;
  background: rgba(0,0,0,0.5) url('img/icon.png') 14px 20px no-repeat;
  padding: 15px;
}

#mamufas h1 {
  font-family: Helvetica, Arial, Sans-serif;
  font-weight: bold;
  font-size: 17px;
  margin: 6px 0 0 106px;
}

#mamufas h4 {
  font-family: Helvetica, Arial, Sans-serif;
  font-size: 14px;
  font-weight: normal;
  line-height: 21px;
  margin: 7px 30px 7px 106px;
  color: rgba(255,255,255,0.8)
}

</style>
<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css">
<script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
<script src="OSMBuildings-Leaflet.js"></script>
<!--script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script-->
</head>

<body>
<div id="map"></div>
<div id="mamufas">
  <h1>Lange Nacht Der Museen Berlin 2014</h1>
  <h4>Museen von spät bis früh — das ist die Lange Nacht der Museen. Vor 17 Jahren in Berlin erfunden, lädt sie in diesem Jahr zum ersten Mal im Mai zum Entdecken, Schlendern, Austauschen und Erleben ein. 80 Türen stehen am 17. Mai 2014 von 18 bis 2 Uhr offen — sie führen in weltberühmte Sammlungen, zu Berliner Originalen, unbekannten Kulturen oder (einst) heißgeliebten Dingen. </h4>
</div>
<script>
var map = new L.Map('map',{
  center: [52.51881, 13.40111],
  zoom: 15,
  minZoom: 15,
  maxZoom: 17,
  zoomControl: false
});

new L.Control.Zoom({ position: 'bottomleft' }).addTo(map);
//L.tileLayer('https://1.maps.nlp.nokia.com/maptile/2.1/maptile/newest/normal.night.grey/{z}/{x}/{y}/256/png8?lg=eng&token=A7tBPacePg9Mj_zghvKt9Q&app_id=KuYppsdXZznpffJsKT24', { maxNativeZoom: 20, maxZoom: 21 }).addTo(map);
//L.tileLayer('http://3.ashbu.cartocdn.com/saleiva/api/v1/map/saleiva@2766fda3@051553ab1b6c394b4ae6ad4831a3611f:1400005116762.3/{z}/{x}/{y}.png').addTo(map);

cartodb.createLayer(map, 'http://saleiva.cartodb.com/api/v2/viz/15f8e4ba-dab0-11e3-be35-0e230854a1cb/viz.json').addTo(map);

var osmb = new OSMBuildings(map)
  .setStyle({ shadows: false })
  .each(function(item) {
    // parse misc osm tags from hastore
    if (item.properties.other_tags) {
      item.properties.other_tags.replace(/,?"([^"]+)"=>"([^"]*)"/g, function(m, k, v) {
        item.properties[k] = v;
      });
      delete item.properties.other_tags;
    }

// if (item.properties.min_height) {
//   console.log(item.properties.min_height);
// }

    // highlight buildings w/ event
    if (item.properties.has_event) {
      item.properties.color = '#ffcc66';
      item.properties.roofColor = '#cc9933';
      item.properties.height = Math.max(20, item.properties.height);
    } else {
      // make other buildings flat
      //delete item.properties.height;
      item.properties.color = 'rgba(47, 57, 64, 0.80)';
      item.properties.roofColor = 'rgba(83, 100, 113, 0.80)';
    }
  })
  .loadData(
    'http://osmbuildings.cartodb.com/api/v2/sql?q='+
    'SELECT a.cartodb_id AS id, 5 AS height, ST_AsText(a.the_geom) AS the_geom, b.cartodb_id>0 AS has_event, a.other_tags '+
    'FROM berlin_filtered AS a LEFT JOIN lndm AS b ON ST_Intersects(a.the_geom, b.the_geom) '+
    'WHERE a.the_geom %26%26 ST_SetSRID(ST_MakeBox2D(ST_Point({w},{s}), ST_Point({e},{n})), 4326) '+
//    'AND b.cartodb_id>0'+
    '&format=geojson'
  );

//  'http://osmbuildings.cartodb.com/api/v2/sql?q='+
//  'SELECT a.cartodb_id AS id, 50 AS height, ST_AsText(a.the_geom) AS the_geom, b.name, b.address, b.cartodb_id>0 AS has_event '+
//  'FROM berlin_filtered AS a LEFT JOIN lndm AS b ON ST_Intersects(a.the_geom, b.the_geom) '+
//  'WHERE a.the_geom %26%26 ST_SetSRID(ST_MakeBox2D(ST_Point({w},{s}), ST_Point({e},{n})), 4326)'+
//  '&format=geojson'
</script>
</body>
</html>